<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner Access</title>
    <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
    <style>
        #interactive {
            position: relative;
            width: 100%;
            height: auto;
        }
        #interactive video {
            width: 100%;
        }
        #userID {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>Scan your Barcode</h2>
    
    <!-- Camera Stream for Barcode Scanning -->
    <div id="interactive" class="viewport"></div>
    
    <!-- Input for manually entered ID -->
    <input type="text" id="userID" placeholder="Enter or scan your ID">
    <button onclick="validateID()">Submit</button>

    <script>
        // Adjusted QuaggaJS initialization for better accuracy
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'), 
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment" // Rear camera
                }
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader"],
                debug: {
                    drawBoundingBox: true,
                    showFrequency: true,
                    drawScanline: true,
                    showPattern: true
                }
            },
            locate: true // Enable locating barcode even if not centered
        }, function(err) {
            if (err) {
                console.error(err);
                alert("Error starting the camera!");
                return;
            }
            Quagga.start();
        });

        // Detect barcode and fill input
        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            console.log('Barcode detected:', code);
            document.getElementById('userID').value = code;
            validateID();
        });

        // Function to validate the ID
        async function validateID() {
            const userInput = document.getElementById("userID").value.trim();

            try {
                const response = await fetch('https://jasset.netlify.app/apps/users/barcode/users.json');
                const data = await response.json();

                const user = data.users.find(u => u.id === userInput);

                if (user) {
                    alert(`Access granted! Welcome, ${user.name}.`);
                } else {
                    alert('Invalid ID. Please try again.');
                }
            } catch (error) {
                alert('Error fetching user data. Please try again later.');
            }
        }
    </script>
</body>
</html>
